name: Run TCK

on:
  push:
    branches:
#      - main
  pull_request:
    branches:
#      - main

env:
  # Tag of the TCK
  TCK_VERSION: v0.2.3

# Only run the latest job
concurrency:
  group: '${{ github.workflow }} @ ${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  prepare-sut:
    name: Preparing Quarkus SUT
    runs-on: ubuntu-latest
    outputs:
      # GitHub Actions don't allow use of env in the run-tck job calling the reusable workflow. Use an output instead
      tck_version: ${{ steps.set_vars.outputs.version }}
    steps:
      - name: Set TCK Version Output
        id: set_vars
        run: echo "version=${{ env.TCK_VERSION }}" >> $GITHUB_OUTPUT
      - name: Checkout a2a-java
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven, skipping tests
        run: mvn -B install -DskipTests
      - name: Prepare Quarkus Image
        run: |
          mkdir artifact-dir
          cp -r tck/target/quarkus-app artifact-dir
          cp .github/workflows/tck/start-sut.sh artifact-dir
          echo
      - name: Upload SUT artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sut-artifact
          path: artifact-dir/

  run-tck:
    name: Running TCK
    uses: a2aproject/a2a-java/.github/workflows/reusable-tck-runner.yml@main
    needs: prepare-sut
    with:
      tag: ${{ needs.prepare-sut.outputs.tck_version }}
      java-version: 17
      sut-url: http://localhost:9999/.well-known/agent.json
